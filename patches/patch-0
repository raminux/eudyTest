#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/debugfs.h>
#include <linux/fs.h>  // file_operations
#include <linux/errno.h>
#include <linux/uaccess.h>
#include <linux/string.h>

struct dentry *dir_dentry;

ssize_t id_read(struct file *file,
	char __user *buf, /* The buffer to fill with data */
	size_t len, /* The length of the buffer */
	loff_t *ppos) /* Our offset in the file */
{
	char *ID = "0c7a48b3b807";

	return simple_read_from_buffer(buf, len, ppos, ID, 12);
}

ssize_t id_write(struct file *file,
	const char __user *buf, /* The buffer to fill with data */
	size_t len, /* The length of the buffer */
	loff_t *ppos) /* Our offset in the file */
{
	char *ID = "0c7a48b3b807";
	char data[12];

	ssize_t ret = simple_write_to_buffer(data, 12, ppos, buf, len);
	if (ret >= 0) {
		if (strncmp(buf, ID, len) == 0) {
			pr_debug("I get your ID\n");
		}
	}
	return ret;
}

const struct file_operations id_fops = {
	.owner = THIS_MODULE,
	.write = id_write,
	.read = id_read,
};


static int __init Task08_init(void)
{
	dir_dentry = debugfs_create_dir("eudyptula", NULL);
	if (!dir_dentry) {
		pr_debug("debugfs not supported in this kernel");
		return -ENODEV;
	}
	
	debugfs_create_file("id", 0666, dir_dentry, NULL, &id_fops);

	pr_debug("Hello, world!\n");
	return 0;
}
static void __exit Task08_exit(void)
{
	debugfs_remove_recursive(dir_dentry);
	pr_debug("Goodbye, world!\n");

}
module_init(Task08_init);
module_exit(Task08_exit);
MODULE_LICENSE("GPL");

// test result - id
raminux@ramlin:~/Linux-Kernel-Challenge/Task08$ sudo insmod moduleTask08.ko
raminux@ramlin:~/Linux-Kernel-Challenge/Task08$ sudo ./readwritetest
Opened successfully!
0c7a48b3b807
Valid write
raminux@ramlin:~/Linux-Kernel-Challenge/Task08$ dmesg
[   59.605527] audit: type=1400 audit(1502200353.859:71): apparmor="STATUS" operation="profile_replace" name="/usr/sbin/cupsd" pid=2089 comm="apparmor_parser"
[  156.102674] systemd-hostnamed[3095]: Warning: nss-myhostname is not installed. Changing the local hostname might make it unresolveable. Please install nss-myhostname!
[  276.797759] Hello, world!
[  790.766467] I get your ID

// test result - jiffies
raminux@ramlin:~/Linux-Kernel-Challenge/Task08$ sudo insmod moduleTask08-p1.ko 
raminux@ramlin:~/Linux-Kernel-Challenge/Task08$ cat /sys/kernel/debug/eudyptula/jiffies 
270507

// test result - foo
raminux@ramlin:~/Linux-Kernel-Challenge/Task08$ cat testfoo.txt > /sys/kernel/debug/eudyptula/foo 
bash: /sys/kernel/debug/eudyptula/foo: Permission denied
raminux@ramlin:~/Linux-Kernel-Challenge/Task08$ sudo cat testfoo.txt > /sys/kernel/debug/eudyptula/foo 
bash: /sys/kernel/debug/eudyptula/foo: Permission denied
raminux@ramlin:~/Linux-Kernel-Challenge/Task08$ sudo -i
root@ramlin:~# cd /home/raminux/Linux-Kernel-Challenge/Task08/
root@ramlin:/home/raminux/Linux-Kernel-Challenge/Task08# cat testfoo.txt > /sys/kernel/debug/eudyptula/foo 
cat: write error: No space left on device
root@ramlin:/home/raminux/Linux-Kernel-Challenge/Task08# cat /sys/kernel/debug/eudyptula/foo > savedfoo.txt
root@ramlin:/home/raminux/Linux-Kernel-Challenge/Task08# ls -l *foo.txt
-rw-r--r-- 1 root    root       4096  Aug   8 19:51 savedfoo.txt
-rw-rw-r-- 1 raminux raminux 1694296  Aug   8 19:36 testfoo.txt
 
